name: 'Scan the tf files with SonarQube'
on: 
  workflow_dispatch:
permissions:   
  security-events: write # Needed to upload-sarif
  contents: read

jobs:
  tf-scan-sonar:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}/Azure/terraform-code
    steps:
    - name: Checkout the code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # Setup terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false
    
    # Terraform Initilize
    - name: Terraform Initilize
      run: terraform init -backend=false

    # Terraform validate
    - name: Terraform Validate
      run: terraform validate

    # Security scan of the terraform code using checkov
    - name: Test with Checkov
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        framework: terraform
    
    # Upload results to GitHub Advanced Security
    - name: Upload SARIF file
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
        category: checkov

    # # Sonar scan for terraform
    # - name: SonarQube Scan
    #   uses: SonarSource/sonarqube-scan-action@v5.0.0
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     SONAR_HOST_URL: https://sonarcloud.io
    #   with:
    #     args: >
    #       -Dsonar.organization=puru7791
    #       -Dsonar.projectKey=terraform-space
    